name: Minikube-in-DinD Node App

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------------------
      # 1. Build and Run DinD Container (The Kubernetes Host)
      # ---------------------------------------------------------------------

      - name: Build Minikube DinD Image
        # Assumes minikube-dind/Dockerfile exists and is configured to run Minikube
        run: docker build -t minikube-dind-node:latest -f minikube-dind/Dockerfile .
      
      - name: Run DinD Container and Stream Logs
        # --privileged is required to run Docker inside Docker
        run: |
          docker run --privileged -d --name minikube-dind-node minikube-dind-node:latest
          # Stream logs in the background for startup monitoring (e.g., Minikube initialization)
          docker logs -f minikube-dind-node &
          
      - name: Wait for Minikube Cluster Readiness ⏳
        # Ensures 'kubectl' is available inside the container before proceeding
        run: |
          echo "Waiting for Minikube to start..."
          TIMEOUT=300
          START_TIME=$(date +%s)
          
          while ! docker exec minikube-dind-node kubectl get nodes > /dev/null 2>&1; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "Minikube failed to start within $TIMEOUT seconds."
              exit 1
            fi
            
            echo "Minikube not ready yet. Waiting 5 seconds..."
            sleep 5
          done
          echo "Minikube is ready!"

      # ---------------------------------------------------------------------
      # 2. Build App Image and Transfer (The Deployment Target)
      # ---------------------------------------------------------------------

      - name: Build App Image and Load into Minikube (FIXED) 🚀
        # Combines build, save, and load into a single pipe to avoid filesystem/access errors
        # Uses -f app/Dockerfile and the context (the current directory '.')
        run: |
          echo "Building Node.js application image..."
          docker build -t my-node-app:latest -f app/Dockerfile .
          
          echo "Transferring image into minikube-dind-node container..."
          # docker save pipes the image binary directly into docker load inside the container
          docker save my-node-app:latest | docker exec -i minikube-dind-node docker load

      # ---------------------------------------------------------------------
      # 3. Deploy to Kubernetes
      # ---------------------------------------------------------------------
      
      - name: Apply Kubernetes Manifest
        # Runs kubectl inside the Minikube container to deploy the app
        run: |
          echo "Applying k8s deployment manifest..."
          docker exec minikube-dind-node kubectl apply -f k8s/deploy-node-app.yaml
          
          echo "Verifying deployment status..."
          docker exec minikube-dind-node kubectl get pods -l app=node-app
          docker exec minikube-dind-node kubectl get services -l app=node-app
