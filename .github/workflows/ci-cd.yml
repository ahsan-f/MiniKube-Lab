name: CI/CD with Minikube, Docker Hub, and GitHub Actions

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  DOCKER_IMAGE_NAME: my-node-app
  DOCKER_REPO: ${{ secrets.DOCKER_USERNAME }}/my-node-app 
  CONTAINER_NAME: minikube-ci-env

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # --- 1. Build and Test Application ---
    # ----------------------------------------------------
    - name: üõ†Ô∏è Set up Docker BuildX
      uses: docker/setup-buildx-action@v3

    - name: üèóÔ∏è Build Application Image
      run: docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest -f app/Dockerfile .

    - name: üß™ Run Application Tests
      run: |
        docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest npm test

    # ----------------------------------------------------
    # --- 2. Minikube Deployment within DinD ---
    # ----------------------------------------------------
    - name: üê≥ Build Minikube-in-DinD Image
      run: docker build -t minikube-dind:latest -f minikube-dind/Dockerfile .

    - name: üöÄ Start Minikube-in-DinD Service and Wait for Kubernetes
      id: start_minikube
      run: |
        TIMEOUT=300 # 5 minutes max wait
        ELAPSED=0
        
        # Start the DinD container
        docker run -d --privileged --name ${{ env.CONTAINER_NAME }} minikube-dind:latest

        echo "Waiting for Minikube Kubernetes API (max ${TIMEOUT} seconds)..."
        
        while [ $ELAPSED -lt $TIMEOUT ]; do
          # Check 1: Did the container crash?
          if ! docker ps -q -f name=${{ env.CONTAINER_NAME }}; then
            echo "::error::Minikube DinD container exited unexpectedly during startup!"
            docker logs ${{ env.CONTAINER_NAME }}
            exit 1
          fi
          
          # Check 2: Is Minikube ready inside the container?
          if docker exec ${{ env.CONTAINER_NAME }} kubectl get nodes >/dev/null 2>&1; then
            echo "Minikube Kubernetes API is ready and configured!"
            break
          fi
          
          sleep 5
          ELAPSED=$((ELAPSED + 5))
        done
        
        if [ $ELAPSED -ge $TIMEOUT ]; then
          echo "::error::Minikube failed to start within the timeout period."
          
          # Added Logging for Diagnostics
          echo "::group::Minikube Status and Logs for Failure Diagnosis"
          docker exec ${{ env.CONTAINER_NAME }} minikube status || true
          docker exec ${{ env.CONTAINER_NAME }} minikube logs --file minikube-ci.log || true
          docker cp ${{ env.CONTAINER_NAME }}:/root/minikube-ci.log . || true
          cat minikube-ci.log || true
          echo "::endgroup::"

          docker logs ${{ env.CONTAINER_NAME }}
          exit 1
        fi

    - name: üì§ Load Application Image into Minikube's Docker Daemon
      run: |
        docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | docker exec -i ${{ env.CONTAINER_NAME }} docker load

    - name: üö¢ Deploy Application to Minikube
      run: |
        # 1. Create Deployment and Service YAML
        cat <<EOF > deployment.yaml
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: my-node-app-deployment
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: my-node-app
          template:
            metadata:
              labels:
                app: my-node-app
            spec:
              containers:
              - name: my-node-app
                image: ${{ env.DOCKER_IMAGE_NAME }}:latest
                imagePullPolicy: Never 
                ports:
                - containerPort: 3000
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: my-node-app-service
        spec:
          selector:
            app: my-node-app
          ports:
            - protocol: TCP
              port: 80
              targetPort: 3000
          type: NodePort
        EOF
        
        # 2. Copy and apply the YAML using the internal kubectl
        docker cp deployment.yaml ${{ env.CONTAINER_NAME }}:/tmp/deployment.yaml
        docker exec ${{ env.CONTAINER_NAME }} kubectl apply -f /tmp/deployment.yaml
        
        # 3. Verify deployment 
        docker exec ${{ env.CONTAINER_NAME }} kubectl rollout status deployment/my-node-app-deployment --timeout=5m

    # ----------------------------------------------------
    # --- 3. Push to Docker Hub ---
    # ----------------------------------------------------
    - name: üîë Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ env.DOCKER_PASSWORD }}

    - name: üè∑Ô∏è Tag and Push Application Image to Docker Hub
      run: |
        docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest ${{ env.DOCKER_REPO }}:latest
        docker push ${{ env.DOCKER_REPO }}:latest

    - name: üßπ Clean up Minikube-in-DinD container
      if: always()
      run: docker stop ${{ env.CONTAINER_NAME }} && docker rm ${{ env.CONTAINER_NAME }}
